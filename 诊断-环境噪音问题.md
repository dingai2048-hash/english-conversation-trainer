# 🔍 诊断：环境噪音问题

## 问题现象

你没说话，但 Whisper 识别出了 "Bye!"

```
[HybridSTT] Audio recorded, size: 20582 bytes
[HybridSTT] Final transcription: Bye!  ← 没说话但识别出内容
```

## 问题分析

### 音频大小分析

- **实际录音**：20582 bytes (20KB)
- **完全安静**：应该 < 5KB
- **结论**：确实录到了声音

### 可能的声音来源

1. **环境噪音**
   - 背景音乐、电视
   - 其他人说话
   - 空调、风扇声音

2. **系统音频**
   - 之前的 TTS 残留
   - 其他应用的声音
   - 系统提示音

3. **操作声音**
   - 键盘敲击声
   - 鼠标点击声
   - 椅子移动声

4. **麦克风太灵敏**
   - 录到远处的声音
   - 录到轻微的噪音

## 修复方案

### 方案 1：提高音频大小阈值 ✅ 已修复

**修改内容**：
```typescript
// 从 1KB 提高到 15KB
if (audioBlob.size < 15000) {
  console.log('[HybridSTT] Audio too short, skipping transcription');
  return '';
}
```

**效果**：
- 过滤掉背景噪音（< 15KB）
- 只处理真正的语音（> 15KB）

### 方案 2：强制刷新浏览器 ⭐⭐⭐

**操作**：
```
macOS: Cmd + Shift + R
Windows: Ctrl + Shift + R
```

**为什么**：
- 清除浏览器缓存
- 加载最新代码
- 确保修复生效

### 方案 3：使用耳机 ⭐⭐⭐⭐⭐

**为什么这是最佳方案**：
- ✅ 完全隔离扬声器和麦克风
- ✅ 不会录到系统音频
- ✅ 不会录到环境噪音
- ✅ 更好的音质
- ✅ 更好的用户体验

### 方案 4：降低麦克风灵敏度

**操作**：
1. 打开系统设置
2. 声音 → 输入
3. 降低输入音量到 50-70%
4. 测试输入电平

## 测试步骤

### 1. 强制刷新浏览器

```
Cmd + Shift + R（macOS）
Ctrl + Shift + R（Windows）
```

### 2. 确保环境安静

- ✅ 关闭音乐、视频
- ✅ 关闭其他应用的声音
- ✅ 确保房间安静
- ✅ 不要动鼠标、键盘

### 3. 开始测试

1. 点击"开始对话"
2. **完全保持安静**
3. 观察控制台日志

### 4. 预期结果

**场景 1：环境完全安静**
```
[HybridSTT] Audio recorded, size: 3000 bytes  ← 很小
[HybridSTT] Audio too short (size: 3000 bytes), skipping transcription
[HybridSTT] Final transcription:   ← 空字符串 ✅
```

**场景 2：有轻微噪音**
```
[HybridSTT] Audio recorded, size: 12000 bytes  ← 中等
[HybridSTT] Audio too short (size: 12000 bytes), skipping transcription
[HybridSTT] Final transcription:   ← 空字符串 ✅
```

**场景 3：有明显声音**
```
[HybridSTT] Audio recorded, size: 25000 bytes  ← 较大
[HybridSTT] Sending to Whisper API for transcription...
[HybridSTT] Final transcription: [识别出的内容]  ← 说明确实有声音
```

## 诊断工具

### 检查麦克风输入

**macOS**：
1. 系统设置 → 声音 → 输入
2. 选择麦克风
3. 观察输入电平条
4. 保持安静时，电平应该很低或不动

**如果电平一直在跳动**：
- 说明麦克风录到了环境噪音
- 需要降低输入音量
- 或者使用耳机

### 检查音频大小

在控制台查看：
```
[HybridSTT] Audio recorded, size: XXXXX bytes
```

**参考值**：
- < 5KB：完全安静 ✅
- 5-15KB：轻微噪音（会被过滤）✅
- 15-25KB：中等声音（可能是噪音或真实语音）
- > 25KB：明显的语音 ✅

## 常见问题

### Q1：为什么提高到 15KB？

**A**：根据测试：
- 完全安静：2-5KB
- 轻微噪音：5-15KB
- 真实语音：20-50KB

15KB 是一个平衡点，可以过滤掉大部分噪音，同时不会误过滤真实语音。

### Q2：会不会过滤掉真实的短语音？

**A**：不会。
- 说一个单词（如 "Hello"）：通常 20-30KB
- 说一个短句（如 "How are you?"）：通常 30-50KB
- 15KB 只会过滤掉非常短的声音或噪音

### Q3：如果还是识别出内容怎么办？

**A**：说明环境确实有声音。请：
1. 使用耳机（最佳方案）
2. 检查是否有其他应用在播放声音
3. 检查麦克风输入电平
4. 尝试在更安静的环境

### Q4：可以进一步提高阈值吗？

**A**：可以。如果 15KB 还不够，可以改为 20KB：

```typescript
if (audioBlob.size < 20000) {  // 改为 20KB
  return '';
}
```

但不建议超过 25KB，否则可能会过滤掉真实的短语音。

## 总结

### 已修复
- ✅ 提高音频大小阈值到 15KB
- ✅ 过滤掉背景噪音和环境音

### 下一步
1. **强制刷新浏览器**（Cmd+Shift+R）
2. **确保环境安静**
3. **测试是否还识别出内容**
4. **如果还有问题，使用耳机**

### 强烈建议
**使用耳机！** 这是最简单、最有效的解决方案。

---

**修复时间**：2026-01-10  
**修复内容**：提高音频大小阈值到 15KB，过滤环境噪音  
**状态**：✅ 已完成，请强制刷新浏览器测试
