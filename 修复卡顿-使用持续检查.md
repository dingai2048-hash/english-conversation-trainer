# 🔧 修复：录音卡顿不会自动停止

## 问题描述

**现象**：界面显示"正在录音... (0.8秒静音后自动提交)"，但是一直卡住不动。

**日志**：
```
[HybridSTT] Initial silence check, time since last speech: 750 ms, isRecording: true
[HybridSTT] Browser STT error (ignored): No speech was detected.
```

## 根本原因

### 问题：`setTimeout` 只检查一次

**旧代码**：
```typescript
this.silenceTimer = setTimeout(() => {
  const timeSinceLastSpeech = Date.now() - this.lastSpeechTime;
  // 只检查一次！
  if (timeSinceLastSpeech >= this.silenceThreshold) {
    this.autoStopCallback();
  }
}, this.silenceThreshold);
```

**时间线**：
```
T+0ms:   开始录音，lastSpeechTime = now
T+800ms: setTimeout 触发，检查时间
         timeSinceLastSpeech = 750ms (因为有延迟)
         750ms < 800ms ❌ 条件不满足
         不触发停止
T+801ms: 浏览器 STT 报错 "no-speech"
T+802ms: 没有后续检查，永远卡住 ❌
```

**问题**：
1. `setTimeout` 只触发一次
2. 如果那时候时间还不够（750ms < 800ms），就不会再检查了
3. 浏览器 STT 报错后，也没有备用机制
4. 系统永远卡在"正在录音"状态

## 修复方案

### 使用 `setInterval` 持续检查 ⭐⭐⭐⭐⭐

**新代码**：
```typescript
// 使用 setInterval 持续检查，而不是 setTimeout 只检查一次
// 每 200ms 检查一次是否应该停止
const checkInterval = 200;
this.silenceTimer = setInterval(() => {
  const timeSinceLastSpeech = Date.now() - this.lastSpeechTime;
  const totalRecordingTime = Date.now() - this.recordingStartTime;
  
  // 持续检查，直到满足条件
  if (!this.hasTriggeredStop && (timeSinceLastSpeech >= this.silenceThreshold || totalRecordingTime >= this.maxRecordingTime)) {
    console.log('[HybridSTT] Silence/timeout detected');
    this.hasTriggeredStop = true;
    
    // 清除计时器
    clearInterval(this.silenceTimer);
    this.silenceTimer = null;
    
    this.autoStopCallback();
  }
}, checkInterval);
```

**新时间线**：
```
T+0ms:    开始录音，lastSpeechTime = now
T+200ms:  检查：750ms < 800ms ❌ 继续
T+400ms:  检查：750ms < 800ms ❌ 继续
T+600ms:  检查：750ms < 800ms ❌ 继续
T+800ms:  检查：800ms >= 800ms ✅ 触发停止！
```

**优势**：
- ✅ 持续检查，不会错过
- ✅ 即使浏览器 STT 失败，也会触发
- ✅ 检查间隔 200ms，响应快速
- ✅ 满足条件后立即停止

## 工作流程

### 修复前的流程（有问题）

```
开始录音
    ↓
启动 setTimeout（800ms）
    ↓
800ms 后触发检查
    ↓
时间不够（750ms < 800ms）❌
    ↓
不触发停止
    ↓
浏览器 STT 报错
    ↓
没有后续检查
    ↓
永远卡住 ❌
```

### 修复后的流程（正确）

```
开始录音
    ↓
启动 setInterval（每 200ms）
    ↓
200ms: 检查 → 不够 → 继续
    ↓
400ms: 检查 → 不够 → 继续
    ↓
600ms: 检查 → 不够 → 继续
    ↓
800ms: 检查 → 够了 ✅
    ↓
触发停止
    ↓
清除计时器
    ↓
发送到 Whisper 识别
```

## 其他修复

### 1. 简化浏览器 STT 回调

**旧代码**：
- 检测到语音时，清除旧计时器
- 启动新的 setTimeout
- 复杂且容易出错

**新代码**：
- 只更新 `lastSpeechTime`
- `setInterval` 会自动检查
- 简单且可靠

```typescript
this.browserSTT.onResult((text: string) => {
  if (text.trim() && text.trim().length >= 2) {
    this.lastSpeechTime = Date.now(); // 只更新时间
    console.log('[HybridSTT] Valid speech detected, updating last speech time');
  }
});
```

### 2. 统一清理逻辑

**更新**：
- 所有清除计时器的地方都改用 `clearInterval`
- 确保资源正确释放

```typescript
// 停止录音时
if (this.silenceTimer) {
  clearInterval(this.silenceTimer);
  this.silenceTimer = null;
}

// 清理资源时
private cleanup(): void {
  if (this.silenceTimer) {
    clearInterval(this.silenceTimer);
    this.silenceTimer = null;
  }
  // ...
}
```

## 测试步骤

### 1. 刷新浏览器

**重要**：必须刷新浏览器（Ctrl+R 或 Cmd+R）才能加载新代码！

### 2. 开始测试

1. 点击"开始对话"
2. 等待 AI 说话
3. **不要说话**，保持安静
4. 观察是否会在 0.8 秒后自动停止

### 3. 预期日志

```
[HybridSTT] Recording started (Browser STT + MediaRecorder)
[HybridSTT] Setting up silence detection, threshold: 800 ms
[HybridSTT] Silence/timeout detected, time since last speech: 800 ms
[HybridSTT] Silence timeout, triggering auto-stop
[App] Auto-stop triggered by sentence detection
[HybridSTT] Stopping recording...
[HybridSTT] MediaRecorder stopped
[HybridSTT] Audio recorded, size: XXXXX bytes
[HybridSTT] Sending to Whisper API for transcription...
[HybridSTT] Final transcription: 
```

**关键点**：
- ✅ 0.8 秒后自动停止
- ✅ 不会卡住
- ✅ 即使浏览器 STT 报错也能停止

### 4. 正常对话测试

1. 点击"开始对话"
2. 等待 AI 说话
3. 说话："Hello"
4. 观察是否正常识别

**预期**：
- ✅ 说话时更新 `lastSpeechTime`
- ✅ 停止说话后 0.8 秒自动停止
- ✅ 正确识别用户的话

## 参数调整

### 调整检查间隔

```typescript
// 在 HybridSTTService.ts 中
const checkInterval = 100; // 改为 100ms，更快响应
```

**建议值**：
- 100ms：更快响应，但 CPU 占用稍高
- 200ms：平衡（推荐）
- 500ms：更省资源，但响应稍慢

### 调整静音阈值

```typescript
// 在 App.tsx 中创建 HybridSTTService 时
silenceThreshold: 1000, // 改为 1 秒
```

**建议值**：
- 500ms：非常快，但可能截断句子
- 800ms：平衡（推荐）
- 1000ms：更宽松，适合慢速说话

## 可能的问题

### 问题 1：仍然卡住

**检查**：
- 是否刷新了浏览器？
- 控制台是否有错误？
- 是否看到 "Silence/timeout detected" 日志？

**解决**：
- 强制刷新（Ctrl+Shift+R 或 Cmd+Shift+R）
- 清除浏览器缓存
- 重启开发服务器

### 问题 2：停止太快

**现象**：刚开始说话就停止了

**原因**：检查间隔太短或阈值太小

**解决**：
- 增加静音阈值到 1000ms
- 或者减少检查间隔到 500ms

### 问题 3：CPU 占用高

**现象**：浏览器变慢

**原因**：检查间隔太短（如 50ms）

**解决**：
- 增加检查间隔到 200ms 或 500ms
- 200ms 已经足够快了

## 总结

### 修复内容

1. **使用 `setInterval` 替代 `setTimeout`**
   - 持续检查，不会错过
   - 每 200ms 检查一次
   - 满足条件后立即停止

2. **简化浏览器 STT 回调**
   - 只更新 `lastSpeechTime`
   - 不再手动管理计时器
   - 代码更简单可靠

3. **统一清理逻辑**
   - 所有地方都用 `clearInterval`
   - 确保资源正确释放

### 效果

- ✅ 不会再卡住
- ✅ 0.8 秒后自动停止
- ✅ 即使浏览器 STT 失败也能工作
- ✅ 代码更简单可靠
- ✅ 用户体验流畅

---

**修复时间**：2026-01-10  
**修复内容**：使用 setInterval 持续检查，替代 setTimeout 单次检查  
**状态**：✅ 已完成，请刷新浏览器测试
