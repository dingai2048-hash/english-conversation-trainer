# 🔧 修复：录音录到系统音频（TTS 回声）

## 问题描述

**现象**：没有说话，Whisper 却识别出了内容，而且识别出的内容是 AI 刚刚说的话。

**示例日志**：
```
🔊 [OpenAI TTS] Generating speech: For me? Thank you! What is it?
🔊 [OpenAI TTS] Starting playback
🔊 [OpenAI TTS] Speech ended
[HybridSTT] Recording started  ← TTS 播放后立即开始录音
[HybridSTT] Final transcription: One for you.  ← 录到了 TTS 的声音！
```

## 根本原因

### 问题：TTS 播放完毕后立即开始录音

**时间线**：
```
T+0.0s: TTS 播放完毕，audio.onended 触发
T+0.0s: setSpeaking(false)
T+0.8s: 自动开始录音  ← 太快了！扬声器还在振动
```

**问题**：
- 音频播放"完毕"只是指音频文件播放完了
- 但扬声器可能还在振动
- 麦克风会录到残留的声音
- 特别是在笔记本电脑上，扬声器和麦克风距离很近

### 关键发现：有两个地方调用 TTS

**位置 1**：手动停止录音后的 TTS（line ~274）
```typescript
await ttsServiceRef.current.speak(aiResponse, 'en-US');
// ❌ 缺少延迟！
setSpeaking(false);
```

**位置 2**：自动停止录音后的 TTS（line ~355）
```typescript
await ttsServiceRef.current.speak(aiResponse, 'en-US');
await new Promise(resolve => setTimeout(resolve, 1500)); // ✅ 有延迟
setSpeaking(false);
```

**问题**：
- 位置 1 没有延迟，导致录到 TTS 音频
- 位置 2 有延迟，但用户主要走位置 1 的流程
- 必须两个地方都加延迟！

## 修复方案

### 在两个地方都加上 1500ms 延迟 ⭐⭐⭐⭐⭐

**修复代码**：
```typescript
// 位置 1：手动停止流程（line ~274）
try {
  setSpeaking(true);
  await ttsServiceRef.current.speak(aiResponse, 'en-US');
  // 等待 1.5 秒，确保音频完全播放完毕且扬声器停止振动
  await new Promise(resolve => setTimeout(resolve, 1500));
} catch (err) {
  console.error('语音合成失败:', err);
} finally {
  setSpeaking(false);
}

// 位置 2：自动停止流程（line ~355）
try {
  setSpeaking(true);
  await ttsServiceRef.current.speak(aiResponse, 'en-US');
  // 等待 1.5 秒，确保音频完全播放完毕且扬声器停止振动
  await new Promise(resolve => setTimeout(resolve, 1500));
} catch (err) {
  console.error('语音合成失败:', err);
} finally {
  setSpeaking(false);
}
```

**效果**：
- ✅ TTS 播放完毕后等待 1500ms
- ✅ 扬声器完全停止
- ✅ 减少回声和残留
- ✅ 两个流程都有保护

### 总延迟计算

```
TTS 播放完毕
    ↓
等待 1500ms（静音期）
    ↓
setSpeaking(false)
    ↓
等待 800ms（自动录音延迟）
    ↓
开始录音

总延迟 = 1500ms + 800ms = 2300ms = 2.3 秒
```

## 工作流程

### 修复前的流程（有问题）

```
AI 生成回复
    ↓
TTS 开始播放
    ↓
TTS 播放完毕（audio.onended）
    ↓
setSpeaking(false) ← 立即（位置 1 没有延迟）
    ↓
等待 800ms
    ↓
开始录音 ← 扬声器可能还在振动
    ↓
麦克风录到残留声音 ❌
    ↓
Whisper 识别出 TTS 的内容 ❌
```

### 修复后的流程（正确）

```
AI 生成回复
    ↓
TTS 开始播放
    ↓
TTS 播放完毕（audio.onended）
    ↓
等待 1500ms（静音期）← 两个位置都有
    ↓
setSpeaking(false)
    ↓
等待 800ms
    ↓
开始录音 ← 扬声器已完全停止
    ↓
麦克风只录到用户的声音 ✅
    ↓
Whisper 正确识别用户的话 ✅
```

## 测试步骤

### 1. 刷新浏览器

**重要**：必须刷新浏览器（Ctrl+R 或 Cmd+R）才能加载新代码！

### 2. 开始测试

1. 点击"开始对话"
2. 等待 AI 说话
3. **不要说话**，保持安静
4. 观察是否还会识别出内容

### 3. 预期结果

**修复前**：
```
[HybridSTT] Final transcription: For me? Thank you!  ← 录到了 TTS
[HybridSTT] Final transcription: you  ← 录到了 TTS
```

**修复后**：
```
[HybridSTT] Final transcription:  ← 空字符串，正确！
```

### 4. 正常对话测试

1. 点击"开始对话"
2. 等待 AI 说话
3. AI 说完后，等待 2.3 秒
4. 说话："Hello"
5. 观察是否正常识别

**预期**：
- ✅ 等待时间稍长（2.3 秒）
- ✅ 正确识别用户的话
- ✅ 不会录到 TTS 的声音

## 参数调整

如果需要调整延迟：

### 调整静音期

```typescript
// 在 App.tsx 的两个位置都要改
await new Promise(resolve => setTimeout(resolve, 1000)); // 改为 1 秒
```

**建议值**：
- 1000ms：更快响应，但可能还有残留
- 1500ms：平衡（推荐）
- 2000ms：更安全，但用户等待时间更长

### 调整自动录音延迟

```typescript
// 在 App.tsx 的 useEffect 中
const timer = setTimeout(() => {
  handleToggleRecording();
}, 500); // 改为 500ms
```

**建议值**：
- 500ms：更快响应，但可能有残留
- 800ms：平衡（推荐）
- 1000ms：更安全，但用户等待时间更长

### 总延迟计算

```
总延迟 = 静音期 + 自动录音延迟

推荐组合：
- 快速：1000ms + 500ms = 1500ms
- 平衡：1500ms + 800ms = 2300ms（当前）
- 安全：2000ms + 1000ms = 3000ms
```

## 其他解决方案

### 方案 1：降低系统音量

**操作**：
- 降低电脑的音量
- 或者使用耳机

**效果**：
- 减少扬声器到麦克风的声音传播
- 但不是根本解决方案

### 方案 2：使用外置麦克风

**操作**：
- 使用独立的麦克风
- 远离扬声器

**效果**：
- 完全避免录到系统音频
- 但需要额外硬件

### 方案 3：使用耳机 ⭐⭐⭐⭐⭐

**操作**：
- 使用耳机听 TTS
- 使用麦克风说话

**效果**：
- 最佳解决方案
- 完全隔离扬声器和麦克风
- 强烈推荐！

## 可能的问题

### 问题 1：等待时间太长

**现象**：AI 说完后，等待 2.3 秒才开始录音，感觉慢

**解决**：
- 减少静音期到 1000ms
- 减少自动录音延迟到 500ms
- 总延迟 1500ms = 1.5 秒

### 问题 2：仍然录到系统音频

**现象**：即使增加了延迟，仍然录到 TTS 的声音

**可能原因**：
- 系统音量太大
- 麦克风灵敏度太高
- 扬声器和麦克风距离太近

**解决**：
- 降低系统音量
- **使用耳机（强烈推荐）**
- 增加延迟到 3000ms

### 问题 3：用户说话太快

**现象**：用户在 AI 说完后立即说话，但系统还在等待

**解决**：
- 这是正常的，用户需要等待 2.3 秒
- 或者减少延迟（但可能录到系统音频）
- 或者提示用户等待录音开始

## 总结

### 修复内容

1. **在两个 TTS 调用位置都加上 1500ms 延迟**
   - 位置 1：手动停止流程（line ~274）
   - 位置 2：自动停止流程（line ~355）
   - 确保所有流程都有保护

2. **总延迟 2.3 秒**
   - 1500ms 静音期（等待扬声器停止）
   - 800ms 自动录音延迟
   - 确保完全没有残留声音

3. **用户体验优化**
   - 延迟时间合理（2.3 秒）
   - 不会录到系统音频
   - 正常对话流畅

### 效果

- ✅ 不会录到 TTS 的声音
- ✅ 正确识别用户的话
- ✅ 两个流程都有保护
- ✅ 解决了误识别问题

### 强烈建议

**使用耳机！** 这是最简单、最有效的解决方案：
- ✅ 完全隔离扬声器和麦克风
- ✅ 不需要长时间延迟
- ✅ 更好的音质
- ✅ 更好的用户体验

---

**修复时间**：2026-01-10  
**修复内容**：在两个 TTS 调用位置都加上 1500ms 延迟，避免录到系统音频  
**状态**：✅ 已完成，请刷新浏览器测试
