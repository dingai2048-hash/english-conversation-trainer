# 🧪 立即测试 - 按住说话模式

## ⚡ 快速测试指南

### 第一步：强制刷新浏览器 ⭐⭐⭐⭐⭐

**必须执行！否则会使用旧代码！**

```bash
macOS: Cmd + Shift + R
Windows: Ctrl + Shift + R
```

### 第二步：打开开发者工具

```bash
按 F12 或 Cmd + Option + I (macOS)
切换到 Console 标签
```

### 第三步：访问应用

```
http://localhost:3000
```

## ✅ 测试清单

### 测试 1：初始状态

**预期结果**：
- [ ] 看到蓝色麦克风按钮
- [ ] 按钮下方显示"点击开始新对话"
- [ ] 提示"开始后按住按钮说话"

**如果不对**：
- 强制刷新浏览器（Cmd+Shift+R）

---

### 测试 2：开始对话

**操作**：
- 点击蓝色麦克风按钮

**预期结果**：
- [ ] 按钮保持蓝色
- [ ] 按钮下方显示"按住按钮说话"
- [ ] 提示"按住按钮开始录音，松开停止"

**如果不对**：
- 查看 Console 是否有错误

---

### 测试 3：按住录音

**操作**：
- 鼠标按住按钮（不要松开）

**预期结果**：
- [ ] 按钮立即变红 🔴
- [ ] 显示"🎤 正在录音..."
- [ ] 提示"松开按钮停止录音"
- [ ] Console 显示：`[HybridSTT] Recording started`

**如果不对**：
- 检查麦克风权限（浏览器会弹出请求）
- 查看 Console 错误日志
- 确认已经强制刷新

---

### 测试 4：说话

**操作**：
- 保持按住按钮
- 说 "Hello, how are you today?"

**预期结果**：
- [ ] 按钮保持红色
- [ ] 显示"🎤 正在录音..."
- [ ] 可以看到考拉视频在播放（listening 状态）

**如果不对**：
- 确认麦克风正常工作
- 检查系统麦克风设置

---

### 测试 5：松开停止

**操作**：
- 松开鼠标按钮

**预期结果**：
- [ ] 按钮立即变灰 ⚫
- [ ] 显示"🔄 正在识别..."
- [ ] 提示"Whisper正在进行高精度识别..."
- [ ] Console 显示：
  ```
  [HybridSTT] Stopping recording...
  [HybridSTT] Audio recorded, size: XXXXX bytes
  [HybridSTT] Sending to Whisper API for transcription...
  ```

**如果不对**：
- 查看 Console 错误日志
- 检查 OpenAI API Key 配置

---

### 测试 6：识别结果

**预期结果**：
- [ ] Console 显示：`[HybridSTT] Final transcription: Hello, how are you today?`
- [ ] 对话记录中显示你的消息
- [ ] 按钮保持灰色（AI 正在思考）

**如果不对**：
- 检查识别出的文本是否正确
- 如果文本 < 5 个字符，不会触发 AI 回复（这是正常的）

---

### 测试 7：AI 回复

**预期结果**：
- [ ] 对话记录中显示 AI 的回复
- [ ] 按钮保持灰色
- [ ] 显示"🗣️ 考拉正在说话..."
- [ ] 听到 TTS 声音 🔊
- [ ] 可以看到考拉视频在播放（speaking 状态）

**如果不对**：
- 检查系统音量
- 检查浏览器标签页是否静音
- 查看 Console 是否有 TTS 错误

---

### 测试 8：回到等待状态

**预期结果**：
- [ ] TTS 播放完成后，按钮恢复蓝色
- [ ] 显示"按住按钮说话"
- [ ] **不会自动开始录音** ⭐⭐⭐⭐⭐
- [ ] 需要再次按住按钮才能继续

**如果不对**：
- 如果自动开始录音了，说明还在用旧代码
- **必须强制刷新**（Cmd+Shift+R）

---

### 测试 9：继续对话

**操作**：
- 再次按住按钮
- 说 "I'm doing great, thanks!"
- 松开按钮

**预期结果**：
- [ ] 重复测试 3-8 的流程
- [ ] 对话记录中显示新的消息
- [ ] 流畅对话

**如果不对**：
- 查看 Console 日志
- 检查是否有错误

---

### 测试 10：结束对话

**操作**：
- 点击"结束对话"按钮（灰色停止图标）

**预期结果**：
- [ ] 系统生成对话摘要
- [ ] 保存到历史记录
- [ ] 回到初始状态
- [ ] 按钮显示"点击开始新对话"

**如果不对**：
- 查看 Console 日志
- 检查 AI 服务是否正常

---

## 🐛 常见问题排查

### 问题 1：按住没反应

**症状**：
- 按住按钮没有变红
- 没有"正在录音"提示

**排查步骤**：
1. [ ] 确认已经强制刷新（Cmd+Shift+R）
2. [ ] 打开 Console，看是否有错误
3. [ ] 检查麦克风权限（浏览器地址栏左侧）
4. [ ] 尝试其他浏览器（Chrome/Edge）

**Console 应该显示**：
```
[HybridSTT] Recording started (Browser STT + MediaRecorder)
```

**如果显示错误**：
```
Failed to start recording: NotAllowedError
→ 麦克风权限被拒绝，需要允许

Failed to start recording: NotFoundError
→ 没有找到麦克风设备

Failed to start recording: NotSupportedError
→ 浏览器不支持
```

---

### 问题 2：松开后没有识别

**症状**：
- 松开按钮后没反应
- 不显示"正在识别"

**排查步骤**：
1. [ ] 查看 Console 日志
2. [ ] 检查录音时长（至少 1-2 秒）
3. [ ] 检查是否说话了

**Console 应该显示**：
```
[HybridSTT] Stopping recording...
[HybridSTT] Audio recorded, size: XXXXX bytes
[HybridSTT] Sending to Whisper API for transcription...
[HybridSTT] Final transcription: ...
```

**如果显示**：
```
[HybridSTT] Audio too short (size: XXX bytes), skipping transcription
→ 录音太短（< 15KB），被过滤了
→ 解决：说完整的句子，录音时间长一点
```

**如果显示**：
```
[HybridSTT] No audio recorded
→ 没有录到音频
→ 解决：检查麦克风是否正常工作
```

---

### 问题 3：识别出的文本不对

**症状**：
- 说的是 A，识别成 B
- 识别出乱码

**排查步骤**：
1. [ ] 查看 Console 中的识别结果
2. [ ] 检查环境噪音
3. [ ] 检查麦克风质量

**Console 应该显示**：
```
[HybridSTT] Final transcription: Hello, how are you today?
```

**如果识别不准确**：
- 使用耳机麦克风
- 在安静的环境
- 说话清晰、慢一点
- 录音时间长一点

---

### 问题 4：没有 AI 回复

**症状**：
- 识别出文本了
- 但是没有 AI 回复

**排查步骤**：
1. [ ] 查看 Console 日志
2. [ ] 检查识别出的文本长度
3. [ ] 检查 API Key 配置

**Console 应该显示**：
```
[HybridSTT] Final transcription: Hello, how are you today?
[App] Sending to AI: Hello, how are you today?
[AI] Response: I'm doing great, thank you! How about you?
```

**如果文本太短**：
```
识别出的文本: "Hi" (2 字符)
→ 文本长度 < 5，不触发 AI 回复（这是正常的）
→ 解决：说完整的句子（至少 5 个字符）
```

**如果显示 API 错误**：
```
[AI] Error: Invalid API key
→ API Key 配置错误
→ 解决：检查设置中的 OpenAI API Key

[AI] Error: Network error
→ 网络问题
→ 解决：检查网络连接
```

---

### 问题 5：没有 TTS 声音

**症状**：
- AI 回复显示了
- 但是没有声音

**排查步骤**：
1. [ ] 检查系统音量
2. [ ] 检查浏览器标签页是否静音
3. [ ] 查看 Console 日志

**Console 应该显示**：
```
[TTS] Speaking: I'm doing great, thank you! How about you?
[TTS] Speech completed
```

**如果显示错误**：
```
[TTS] Error: Failed to fetch
→ OpenAI TTS API 调用失败
→ 解决：检查 API Key 配置

[TTS] Error: NotAllowedError
→ 浏览器自动播放策略
→ 解决：允许浏览器自动播放音频
```

---

### 问题 6：还是自动录音

**症状**：
- AI 说完后自动开始录音
- 没有按住按钮就开始录音

**原因**：
- 100% 是浏览器缓存问题
- 还在使用旧代码

**解决方案**：
1. [ ] **强制刷新**（Cmd+Shift+R）⭐⭐⭐⭐⭐
2. [ ] 清除浏览器缓存
3. [ ] 重启浏览器
4. [ ] 查看 Console 确认代码版本

**验证方法**：
- 打开 Console
- 搜索 "onAutoStop"
- 如果找到这个词，说明还在用旧代码
- 新代码中不应该有 "onAutoStop"

---

## 📊 测试结果记录

### 测试环境

- [ ] 浏览器：Chrome / Safari / Edge / Firefox
- [ ] 操作系统：macOS / Windows / Linux
- [ ] 设备：桌面端 / 移动端

### 测试结果

| 测试项 | 结果 | 备注 |
|--------|------|------|
| 1. 初始状态 | ✅ / ❌ | |
| 2. 开始对话 | ✅ / ❌ | |
| 3. 按住录音 | ✅ / ❌ | |
| 4. 说话 | ✅ / ❌ | |
| 5. 松开停止 | ✅ / ❌ | |
| 6. 识别结果 | ✅ / ❌ | |
| 7. AI 回复 | ✅ / ❌ | |
| 8. 回到等待状态 | ✅ / ❌ | |
| 9. 继续对话 | ✅ / ❌ | |
| 10. 结束对话 | ✅ / ❌ | |

### 关键验证 ⭐⭐⭐⭐⭐

- [ ] **AI 说完后不会自动录音**
- [ ] **需要按住按钮才能录音**
- [ ] **松开按钮立即停止**
- [ ] **不会误触发**

如果以上 4 点都通过，说明实现正确！

---

## 🎉 测试通过后

恭喜！你的应用现在已经完全实现了 GetFluently.app 风格的按住说话交互！

### 下一步

1. **享受流畅对话**
2. **练习英语口语**
3. **提高发音**

### 如果需要调整

告诉我你想要：
1. 调整文本长度过滤（当前 >= 5 字符）
2. 调整音频大小过滤（当前 >= 15KB）
3. 调整 TTS 延迟（当前 1.5 秒）
4. 其他功能

我会帮你调整！

---

**测试时间**：2026-01-10  
**状态**：✅ 准备测试  
**重要**：必须强制刷新浏览器！  
**目标**：验证 GetFluently.app 风格的按住说话交互
