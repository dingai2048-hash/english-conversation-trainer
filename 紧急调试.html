<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸš¨ ç´§æ€¥è°ƒè¯•å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 32px;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 16px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            border-left: 4px solid #667eea;
        }
        
        .section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 20px;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .result {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .success {
            color: #10b981;
            font-weight: 600;
        }
        
        .error {
            color: #ef4444;
            font-weight: 600;
        }
        
        .warning {
            color: #f59e0b;
            font-weight: 600;
        }
        
        .info {
            color: #3b82f6;
            font-weight: 600;
        }
        
        pre {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            margin-top: 10px;
        }
        
        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .status-ok {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-error {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .status-warning {
            background: #fef3c7;
            color: #92400e;
        }
        
        .copy-btn {
            background: #6b7280;
            padding: 8px 16px;
            font-size: 14px;
            margin-top: 10px;
        }
        
        .copy-btn:hover {
            background: #4b5563;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš¨ ç´§æ€¥è°ƒè¯•å·¥å…·</h1>
        <p class="subtitle">å¿«é€Ÿè¯Šæ–­ AI æ— å›åº”é—®é¢˜</p>
        
        <!-- ç¬¬ 1 æ­¥ï¼šæ£€æŸ¥é…ç½® -->
        <div class="section">
            <h2>ğŸ“‹ ç¬¬ 1 æ­¥ï¼šæ£€æŸ¥é…ç½®</h2>
            <button onclick="checkConfig()">ğŸ” æ£€æŸ¥é…ç½®</button>
            <div id="configResult" class="result" style="display:none;"></div>
        </div>
        
        <!-- ç¬¬ 2 æ­¥ï¼šæµ‹è¯• API è¿æ¥ -->
        <div class="section">
            <h2>ğŸŒ ç¬¬ 2 æ­¥ï¼šæµ‹è¯• OpenAI API</h2>
            <button onclick="testOpenAI()">ğŸ§ª æµ‹è¯• API è¿æ¥</button>
            <div id="apiResult" class="result" style="display:none;"></div>
        </div>
        
        <!-- ç¬¬ 3 æ­¥ï¼šæµ‹è¯•è¯­éŸ³è¯†åˆ« -->
        <div class="section">
            <h2>ğŸ¤ ç¬¬ 3 æ­¥ï¼šæµ‹è¯•è¯­éŸ³è¯†åˆ«</h2>
            <button onclick="testSpeechRecognition()">ğŸ™ï¸ æµ‹è¯•éº¦å…‹é£</button>
            <button onclick="stopSpeechRecognition()">â¹ï¸ åœæ­¢</button>
            <div id="speechResult" class="result" style="display:none;"></div>
        </div>
        
        <!-- ç¬¬ 4 æ­¥ï¼šæŸ¥çœ‹æµè§ˆå™¨æ—¥å¿— -->
        <div class="section">
            <h2>ğŸ“ ç¬¬ 4 æ­¥ï¼šæŸ¥çœ‹æµè§ˆå™¨æ—¥å¿—</h2>
            <p style="color: #666; margin-bottom: 15px;">
                è¯·æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼ˆæŒ‰ F12 æˆ– Cmd+Option+Iï¼‰ï¼Œç„¶åï¼š
            </p>
            <ol style="color: #666; margin-left: 20px; line-height: 1.8;">
                <li>åˆ‡æ¢åˆ° <strong>Console</strong> æ ‡ç­¾</li>
                <li>ç‚¹å‡»éº¦å…‹é£è¯´è¯</li>
                <li>æŸ¥çœ‹æ˜¯å¦æœ‰çº¢è‰²é”™è¯¯ä¿¡æ¯</li>
                <li>å¤åˆ¶é”™è¯¯ä¿¡æ¯</li>
            </ol>
            <button onclick="copyInstructions()">ğŸ“‹ å¤åˆ¶è°ƒè¯•æŒ‡ä»¤</button>
        </div>
        
        <!-- ç¬¬ 5 æ­¥ï¼šå®Œæ•´æµç¨‹æµ‹è¯• -->
        <div class="section">
            <h2>ğŸ”„ ç¬¬ 5 æ­¥ï¼šå®Œæ•´æµç¨‹æµ‹è¯•</h2>
            <button onclick="fullFlowTest()">ğŸš€ è¿è¡Œå®Œæ•´æµ‹è¯•</button>
            <div id="fullTestResult" class="result" style="display:none;"></div>
        </div>
        
        <!-- è¯Šæ–­ç»“æœ -->
        <div class="section" id="diagnosisSection" style="display:none;">
            <h2>ğŸ¯ è¯Šæ–­ç»“æœ</h2>
            <div id="diagnosisResult" class="result"></div>
        </div>
    </div>

    <script>
        let recognition = null;
        let diagnosisData = {
            config: null,
            api: null,
            speech: null
        };

        // æ£€æŸ¥é…ç½®
        function checkConfig() {
            const resultDiv = document.getElementById('configResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<p class="info">â³ æ­£åœ¨æ£€æŸ¥é…ç½®...</p>';
            
            try {
                const settings = localStorage.getItem('ai-conversation-settings');
                
                if (!settings) {
                    resultDiv.innerHTML = `
                        <p class="error">âŒ æœªæ‰¾åˆ°é…ç½®</p>
                        <p>è¯·å…ˆé…ç½® OpenAI API Key</p>
                        <button onclick="window.open('è‡ªåŠ¨é…ç½®OpenAI.html', '_blank')">æ‰“å¼€é…ç½®å·¥å…·</button>
                    `;
                    diagnosisData.config = { status: 'error', message: 'æœªæ‰¾åˆ°é…ç½®' };
                    return;
                }
                
                const config = JSON.parse(settings);
                
                let html = '<p class="success">âœ… æ‰¾åˆ°é…ç½®</p><pre>';
                html += `æä¾›å•†: ${config.provider || 'æœªè®¾ç½®'}\n`;
                html += `æ¨¡å‹: ${config.model || 'æœªè®¾ç½®'}\n`;
                html += `API Key: ${config.apiKey ? config.apiKey.substring(0, 20) + '...' : 'æœªè®¾ç½®'}\n`;
                html += `ç«¯ç‚¹: ${config.endpoint || 'æœªè®¾ç½®'}\n`;
                html += `TTS æä¾›å•†: ${config.ttsProvider || 'æœªè®¾ç½®'}\n`;
                html += `TTS éŸ³è‰²: ${config.openaiTTSVoice || 'æœªè®¾ç½®'}\n`;
                html += `TTS æ¨¡å‹: ${config.openaiTTSModel || 'æœªè®¾ç½®'}\n`;
                html += '</pre>';
                
                // æ£€æŸ¥å…³é”®é…ç½®
                const issues = [];
                if (!config.apiKey || config.apiKey === 'mock') {
                    issues.push('âŒ API Key æœªè®¾ç½®æˆ–ä½¿ç”¨ mock');
                }
                if (!config.provider || config.provider === 'mock') {
                    issues.push('âŒ æä¾›å•†æœªè®¾ç½®æˆ–ä½¿ç”¨ mock');
                }
                if (!config.endpoint) {
                    issues.push('âš ï¸ API ç«¯ç‚¹æœªè®¾ç½®');
                }
                
                if (issues.length > 0) {
                    html += '<p class="warning">âš ï¸ å‘ç°é—®é¢˜ï¼š</p><ul>';
                    issues.forEach(issue => {
                        html += `<li>${issue}</li>`;
                    });
                    html += '</ul>';
                    html += '<button onclick="window.open(\'è‡ªåŠ¨é…ç½®OpenAI.html\', \'_blank\')">é‡æ–°é…ç½®</button>';
                    diagnosisData.config = { status: 'warning', issues };
                } else {
                    html += '<p class="success">âœ… é…ç½®çœ‹èµ·æ¥æ­£å¸¸</p>';
                    diagnosisData.config = { status: 'ok', config };
                }
                
                resultDiv.innerHTML = html;
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <p class="error">âŒ é…ç½®è§£æå¤±è´¥</p>
                    <pre>${error.message}</pre>
                    <button onclick="window.open('è‡ªåŠ¨é…ç½®OpenAI.html', '_blank')">é‡æ–°é…ç½®</button>
                `;
                diagnosisData.config = { status: 'error', error: error.message };
            }
        }

        // æµ‹è¯• OpenAI API
        async function testOpenAI() {
            const resultDiv = document.getElementById('apiResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<p class="info">â³ æ­£åœ¨æµ‹è¯• OpenAI API...</p>';
            
            try {
                const settings = localStorage.getItem('ai-conversation-settings');
                if (!settings) {
                    resultDiv.innerHTML = '<p class="error">âŒ æœªæ‰¾åˆ°é…ç½®ï¼Œè¯·å…ˆé…ç½®</p>';
                    return;
                }
                
                const config = JSON.parse(settings);
                
                if (!config.apiKey || config.apiKey === 'mock') {
                    resultDiv.innerHTML = '<p class="error">âŒ API Key æœªè®¾ç½®æˆ–ä½¿ç”¨ mock</p>';
                    return;
                }
                
                const endpoint = config.endpoint || 'https://api.openai.com/v1/chat/completions';
                
                resultDiv.innerHTML = '<p class="info">â³ æ­£åœ¨è°ƒç”¨ API...</p>';
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${config.apiKey}`
                    },
                    body: JSON.stringify({
                        model: config.model || 'gpt-4o',
                        messages: [
                            { role: 'system', content: 'You are a helpful assistant.' },
                            { role: 'user', content: 'Say "Hello, I am working!" in one sentence.' }
                        ],
                        max_tokens: 50
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    let errorMsg = data.error?.message || response.statusText;
                    resultDiv.innerHTML = `
                        <p class="error">âŒ API è°ƒç”¨å¤±è´¥</p>
                        <p><strong>çŠ¶æ€ç :</strong> ${response.status}</p>
                        <p><strong>é”™è¯¯ä¿¡æ¯:</strong></p>
                        <pre>${errorMsg}</pre>
                        <button class="copy-btn" onclick="copyText('${errorMsg.replace(/'/g, "\\'")}')">å¤åˆ¶é”™è¯¯</button>
                    `;
                    diagnosisData.api = { status: 'error', statusCode: response.status, error: errorMsg };
                    return;
                }
                
                const reply = data.choices[0].message.content;
                resultDiv.innerHTML = `
                    <p class="success">âœ… API è°ƒç”¨æˆåŠŸï¼</p>
                    <p><strong>AI å›å¤:</strong></p>
                    <pre>${reply}</pre>
                    <p class="success">âœ… OpenAI API å·¥ä½œæ­£å¸¸</p>
                `;
                diagnosisData.api = { status: 'ok', reply };
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <p class="error">âŒ æµ‹è¯•å¤±è´¥</p>
                    <pre>${error.message}</pre>
                    <button class="copy-btn" onclick="copyText('${error.message.replace(/'/g, "\\'")}')">å¤åˆ¶é”™è¯¯</button>
                `;
                diagnosisData.api = { status: 'error', error: error.message };
            }
        }

        // æµ‹è¯•è¯­éŸ³è¯†åˆ«
        function testSpeechRecognition() {
            const resultDiv = document.getElementById('speechResult');
            resultDiv.style.display = 'block';
            
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                resultDiv.innerHTML = '<p class="error">âŒ æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«</p><p>è¯·ä½¿ç”¨ Chrome æˆ– Edge æµè§ˆå™¨</p>';
                return;
            }
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';
            
            let transcript = '';
            
            recognition.onstart = () => {
                resultDiv.innerHTML = '<p class="success">âœ… éº¦å…‹é£å·²å¯åŠ¨</p><p class="info">ğŸ¤ è¯·è¯´è¯...</p>';
            };
            
            recognition.onresult = (event) => {
                transcript = '';
                for (let i = 0; i < event.results.length; i++) {
                    transcript += event.results[i][0].transcript + ' ';
                }
                resultDiv.innerHTML = `
                    <p class="success">âœ… æ­£åœ¨è¯†åˆ«...</p>
                    <p><strong>è¯†åˆ«å†…å®¹:</strong></p>
                    <pre>${transcript}</pre>
                `;
                diagnosisData.speech = { status: 'ok', transcript };
            };
            
            recognition.onerror = (event) => {
                resultDiv.innerHTML = `
                    <p class="error">âŒ è¯­éŸ³è¯†åˆ«é”™è¯¯</p>
                    <pre>${event.error}</pre>
                `;
                diagnosisData.speech = { status: 'error', error: event.error };
            };
            
            recognition.onend = () => {
                resultDiv.innerHTML += '<p class="warning">âš ï¸ è¯­éŸ³è¯†åˆ«å·²åœæ­¢</p>';
            };
            
            try {
                recognition.start();
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">âŒ å¯åŠ¨å¤±è´¥: ${error.message}</p>`;
            }
        }

        function stopSpeechRecognition() {
            if (recognition) {
                recognition.stop();
            }
        }

        // å®Œæ•´æµç¨‹æµ‹è¯•
        async function fullFlowTest() {
            const resultDiv = document.getElementById('fullTestResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<p class="info">â³ å¼€å§‹å®Œæ•´æµç¨‹æµ‹è¯•...</p>';
            
            let html = '<h3>æµ‹è¯•ç»“æœï¼š</h3>';
            
            // 1. æ£€æŸ¥é…ç½®
            html += '<p>1ï¸âƒ£ æ£€æŸ¥é…ç½®...</p>';
            try {
                const settings = localStorage.getItem('ai-conversation-settings');
                if (!settings) {
                    html += '<p class="error">âŒ é…ç½®ä¸å­˜åœ¨</p>';
                    resultDiv.innerHTML = html;
                    return;
                }
                const config = JSON.parse(settings);
                if (!config.apiKey || config.apiKey === 'mock') {
                    html += '<p class="error">âŒ API Key æœªè®¾ç½®</p>';
                    resultDiv.innerHTML = html;
                    return;
                }
                html += '<p class="success">âœ… é…ç½®æ­£å¸¸</p>';
            } catch (error) {
                html += `<p class="error">âŒ é…ç½®é”™è¯¯: ${error.message}</p>`;
                resultDiv.innerHTML = html;
                return;
            }
            
            resultDiv.innerHTML = html;
            
            // 2. æµ‹è¯• API
            html += '<p>2ï¸âƒ£ æµ‹è¯• API è¿æ¥...</p>';
            resultDiv.innerHTML = html;
            
            try {
                const settings = JSON.parse(localStorage.getItem('ai-conversation-settings'));
                const response = await fetch(settings.endpoint || 'https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${settings.apiKey}`
                    },
                    body: JSON.stringify({
                        model: settings.model || 'gpt-4o',
                        messages: [{ role: 'user', content: 'Hi' }],
                        max_tokens: 20
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    html += `<p class="error">âŒ API è°ƒç”¨å¤±è´¥: ${error.error?.message || response.statusText}</p>`;
                    resultDiv.innerHTML = html;
                    return;
                }
                
                html += '<p class="success">âœ… API è¿æ¥æ­£å¸¸</p>';
            } catch (error) {
                html += `<p class="error">âŒ API æµ‹è¯•å¤±è´¥: ${error.message}</p>`;
                resultDiv.innerHTML = html;
                return;
            }
            
            resultDiv.innerHTML = html;
            
            // 3. æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
            html += '<p>3ï¸âƒ£ æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ...</p>';
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                html += '<p class="error">âŒ æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«</p>';
            } else {
                html += '<p class="success">âœ… æµè§ˆå™¨æ”¯æŒè¯­éŸ³è¯†åˆ«</p>';
            }
            
            resultDiv.innerHTML = html;
            
            // æ€»ç»“
            html += '<hr style="margin: 20px 0;"><h3>ğŸ¯ è¯Šæ–­æ€»ç»“ï¼š</h3>';
            html += '<p class="success">âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼</p>';
            html += '<p>å¦‚æœåº”ç”¨è¿˜æ˜¯ä¸å·¥ä½œï¼Œè¯·ï¼š</p>';
            html += '<ol style="margin-left: 20px; line-height: 1.8;">';
            html += '<li>æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰</li>';
            html += '<li>åˆ‡æ¢åˆ° Console æ ‡ç­¾</li>';
            html += '<li>ç‚¹å‡»éº¦å…‹é£è¯´è¯</li>';
            html += '<li>æŸ¥çœ‹çº¢è‰²é”™è¯¯ä¿¡æ¯</li>';
            html += '<li>å¤åˆ¶é”™è¯¯ä¿¡æ¯å¹¶å‘Šè¯‰å¼€å‘è€…</li>';
            html += '</ol>';
            
            resultDiv.innerHTML = html;
            
            // æ˜¾ç¤ºè¯Šæ–­ç»“æœ
            showDiagnosis();
        }

        function showDiagnosis() {
            const section = document.getElementById('diagnosisSection');
            const resultDiv = document.getElementById('diagnosisResult');
            
            section.style.display = 'block';
            
            let html = '<h3>å®Œæ•´è¯Šæ–­æŠ¥å‘Šï¼š</h3>';
            html += '<pre>' + JSON.stringify(diagnosisData, null, 2) + '</pre>';
            html += '<button class="copy-btn" onclick="copyDiagnosis()">ğŸ“‹ å¤åˆ¶è¯Šæ–­æŠ¥å‘Š</button>';
            
            resultDiv.innerHTML = html;
        }

        function copyText(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('âœ… å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            });
        }

        function copyDiagnosis() {
            const text = JSON.stringify(diagnosisData, null, 2);
            navigator.clipboard.writeText(text).then(() => {
                alert('âœ… è¯Šæ–­æŠ¥å‘Šå·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            });
        }

        function copyInstructions() {
            const text = `
è°ƒè¯•æ­¥éª¤ï¼š
1. æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12 æˆ– Cmd+Option+Iï¼‰
2. åˆ‡æ¢åˆ° Console æ ‡ç­¾
3. åœ¨åº”ç”¨ä¸­ç‚¹å‡»éº¦å…‹é£
4. è¯´ä¸€å¥è‹±è¯­
5. æŸ¥çœ‹æ§åˆ¶å°ä¸­çš„æ—¥å¿—å’Œé”™è¯¯
6. å¤åˆ¶æ‰€æœ‰çº¢è‰²é”™è¯¯ä¿¡æ¯
7. å°†é”™è¯¯ä¿¡æ¯å‘é€ç»™å¼€å‘è€…

ç‰¹åˆ«æ³¨æ„ï¼š
- æŸ¥æ‰¾åŒ…å« [App] çš„æ—¥å¿—
- æŸ¥æ‰¾åŒ…å« [OpenAI TTS] çš„æ—¥å¿—
- æŸ¥æ‰¾åŒ…å« [SpeechRecognition] çš„æ—¥å¿—
- æŸ¥æ‰¾ä»»ä½•çº¢è‰²çš„é”™è¯¯ä¿¡æ¯
            `.trim();
            
            navigator.clipboard.writeText(text).then(() => {
                alert('âœ… è°ƒè¯•æŒ‡ä»¤å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            });
        }
    </script>
</body>
</html>
