# 🚨 紧急修复：录音卡顿问题

## 问题描述

用户反馈：点击开始对话后，界面显示"正在录音..."，但是一直卡在这个状态，无法自动提交。

## 根本原因

### 问题 1：静音检测计时器未启动

**原因**：
- 静音检测计时器只在浏览器 STT 检测到语音时才启动
- 如果浏览器 STT 没有识别到任何内容，计时器永远不会启动
- 导致系统永远等待，无法自动停止

**代码问题**：
```typescript
// 旧代码：只在检测到语音时启动计时器
this.browserSTT.onResult((text: string) => {
  if (text.trim()) {
    // 只有这里才启动计时器
    this.silenceTimer = setTimeout(...)
  }
});
```

### 问题 2：浏览器 STT 启动失败

**原因**：
- 某些浏览器或环境下，浏览器 STT 可能启动失败
- 如果启动失败，整个录音流程会中断
- 没有备用方案

## 已实施的修复

### 修复 1：添加初始计时器 ⭐⭐⭐⭐⭐

```typescript
private setupBrowserSTTForSilenceDetection(): void {
  // 立即启动初始计时器（无论是否检测到语音）
  this.silenceTimer = setTimeout(() => {
    const timeSinceLastSpeech = Date.now() - this.lastSpeechTime;
    if (timeSinceLastSpeech >= this.silenceThreshold && this.isRecording) {
      console.log('[HybridSTT] Initial silence timeout, triggering auto-stop');
      if (this.autoStopCallback) {
        this.autoStopCallback();
      }
    }
  }, this.silenceThreshold);
  
  // 然后监听浏览器 STT 结果
  this.browserSTT.onResult((text: string) => {
    // 检测到语音时重置计时器
    ...
  });
}
```

**效果**：
- 即使浏览器 STT 没有识别到任何内容
- 0.8 秒后也会自动停止
- 不会永远卡住

### 修复 2：添加备用计时器 ⭐⭐⭐⭐

```typescript
try {
  await this.browserSTT.startRecording();
} catch (error) {
  console.warn('[HybridSTT] Browser STT failed, using fallback timer');
  // 如果浏览器 STT 启动失败，使用备用计时器
  this.startFallbackTimer();
}

private startFallbackTimer(): void {
  // 最大录音时间 10 秒，防止永远卡住
  this.silenceTimer = setTimeout(() => {
    if (this.isRecording && this.autoStopCallback) {
      this.autoStopCallback();
    }
  }, 10000);
}
```

**效果**：
- 即使浏览器 STT 完全失败
- 10 秒后也会自动停止
- 确保不会永远卡住

### 修复 3：添加详细日志 ⭐⭐⭐

```typescript
console.log('[HybridSTT] Setting up silence detection, threshold:', this.silenceThreshold, 'ms');
console.log('[HybridSTT] Browser STT result:', text);
console.log('[HybridSTT] Speech detected, resetting silence timer');
console.log('[HybridSTT] Silence check, time since last speech:', timeSinceLastSpeech, 'ms');
```

**效果**：
- 可以在控制台看到详细的执行流程
- 方便诊断问题
- 了解系统在做什么

## 测试步骤

### 1. 重启应用

```bash
# 停止当前应用（Ctrl+C）
# 重新启动
npm start
```

### 2. 打开浏览器控制台

按 F12 打开开发者工具，切换到 Console 标签

### 3. 开始测试

1. 点击蓝色麦克风按钮
2. 说话："Hello"
3. 观察控制台日志

### 4. 预期日志

```
[HybridSTT] Recording started (Browser STT + MediaRecorder)
[HybridSTT] Setting up silence detection, threshold: 800 ms
[HybridSTT] Browser STT result: hello
[HybridSTT] Speech detected, resetting silence timer
[HybridSTT] Silence check after speech, time: 850 ms
[HybridSTT] Silence detected, triggering auto-stop
[HybridSTT] Stopping recording...
[HybridSTT] MediaRecorder stopped
[HybridSTT] Audio recorded, size: XXXXX bytes
[HybridSTT] Sending to Whisper API for transcription...
```

## 可能的情况

### 情况 1：正常工作

**日志**：
```
[HybridSTT] Browser STT result: hello
[HybridSTT] Speech detected, resetting silence timer
[HybridSTT] Silence detected, triggering auto-stop
```

**说明**：浏览器 STT 正常工作，检测到语音并触发停止

### 情况 2：浏览器 STT 无响应

**日志**：
```
[HybridSTT] Setting up silence detection, threshold: 800 ms
[HybridSTT] Initial silence check, time since last speech: 850 ms
[HybridSTT] Initial silence timeout, triggering auto-stop
```

**说明**：浏览器 STT 没有识别到内容，但初始计时器触发了停止

### 情况 3：浏览器 STT 启动失败

**日志**：
```
[HybridSTT] Browser STT failed to start, using fallback timer
[HybridSTT] Fallback timer triggered, auto-stopping
```

**说明**：浏览器 STT 启动失败，备用计时器触发了停止

### 情况 4：autoStopCallback 未注册

**日志**：
```
[HybridSTT] Silence detected, triggering auto-stop
[HybridSTT] No autoStopCallback registered!
```

**说明**：回调函数没有注册，需要检查 App.tsx 的代码

## 如果还是卡住

### 检查 1：autoStopCallback 是否注册

在 App.tsx 中，确保这段代码存在：

```typescript
if (sttServiceRef.current.onAutoStop) {
  sttServiceRef.current.onAutoStop(async () => {
    console.log('[App] Auto-stop triggered');
    // 处理停止逻辑
  });
}
```

### 检查 2：浏览器兼容性

- 使用 Chrome 或 Edge 浏览器
- 确保浏览器版本是最新的
- 检查麦克风权限是否允许

### 检查 3：网络连接

- 确保可以访问 OpenAI API
- 检查网络是否稳定
- 查看是否有防火墙阻止

## 临时解决方案

如果修复后还是有问题，可以临时切换回浏览器 STT：

1. 打开设置
2. STT 提供商：选择 **Browser**（浏览器）
3. 保存设置

这样就不会使用混合模式，直接使用浏览器 STT。

## 下一步

如果问题解决了：
- ✅ 继续使用混合模式
- ✅ 享受高准确率的 Whisper 识别

如果问题还存在：
- 📋 复制控制台的完整日志给我
- 🔍 我会进一步诊断问题
- 🛠️ 提供更深入的修复方案

---

**修复时间**：2026-01-10  
**修复内容**：
- ✅ 添加初始静音计时器
- ✅ 添加备用计时器
- ✅ 添加详细日志
- ✅ 防止永远卡住

**状态**：✅ 已部署，请测试
