<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Key ç®¡ç†</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        .section {
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .section h2 {
            margin-top: 0;
            color: #4F46E5;
        }
        .key-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #4F46E5;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .key-info {
            flex: 1;
        }
        .key-info h3 {
            margin: 0 0 5px 0;
            color: #333;
        }
        .key-info p {
            margin: 3px 0;
            color: #666;
            font-size: 14px;
        }
        .key-value {
            font-family: monospace;
            background: #e9ecef;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 13px;
        }
        .key-actions {
            display: flex;
            gap: 10px;
        }
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        button.primary {
            background: #4F46E5;
            color: white;
        }
        button.primary:hover {
            background: #4338CA;
        }
        button.danger {
            background: #dc3545;
            color: white;
        }
        button.danger:hover {
            background: #c82333;
        }
        button.secondary {
            background: #6c757d;
            color: white;
        }
        button.secondary:hover {
            background: #5a6268;
        }
        input, select {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        .form-group {
            margin: 15px 0;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”‘ API Key ç®¡ç†</h1>
        <p>ä¿å­˜å’Œç®¡ç†ä½ çš„ API Keys</p>

        <div class="warning">
            <strong>âš ï¸ å®‰å…¨æç¤ºï¼š</strong> API Keys ä¿å­˜åœ¨æµè§ˆå™¨çš„ localStorage ä¸­ã€‚è¯·ä¸è¦åœ¨å…¬å…±ç”µè„‘ä¸Šä¿å­˜æ•æ„Ÿçš„ Keysã€‚
        </div>

        <!-- æ·»åŠ æ–° Key -->
        <div class="section">
            <h2>â• æ·»åŠ æ–° API Key</h2>
            <div class="form-group">
                <label>æœåŠ¡å•†</label>
                <select id="newProvider">
                    <option value="openai">OpenAI</option>
                    <option value="replicate">Replicate</option>
                    <option value="azure">Azure OpenAI</option>
                    <option value="anthropic">Anthropic Claude</option>
                    <option value="doubao">è±†åŒ…</option>
                    <option value="custom">è‡ªå®šä¹‰</option>
                </select>
            </div>
            <div class="form-group">
                <label>åç§°ï¼ˆå¤‡æ³¨ï¼‰</label>
                <input type="text" id="newName" placeholder="ä¾‹å¦‚ï¼šæˆ‘çš„ OpenAI Key">
            </div>
            <div class="form-group">
                <label>API Key</label>
                <input type="password" id="newKey" placeholder="è¾“å…¥ API Key">
            </div>
            <button class="primary" onclick="addKey()">ğŸ’¾ ä¿å­˜ Key</button>
        </div>

        <!-- å·²ä¿å­˜çš„ Keys -->
        <div class="section">
            <h2>ğŸ“‹ å·²ä¿å­˜çš„ Keys</h2>
            <div id="keysList"></div>
        </div>
    </div>

    <script>
        const STORAGE_KEY = 'english-trainer-saved-api-keys';

        function loadKeys() {
            try {
                const stored = localStorage.getItem(STORAGE_KEY);
                return stored ? JSON.parse(stored) : [];
            } catch (error) {
                console.error('Failed to load keys:', error);
                return [];
            }
        }

        function saveKeys(keys) {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(keys));
            } catch (error) {
                console.error('Failed to save keys:', error);
                alert('ä¿å­˜å¤±è´¥ï¼š' + error.message);
            }
        }

        function maskKey(key) {
            if (key.length <= 10) {
                return '***';
            }
            return `${key.substring(0, 8)}...${key.substring(key.length - 4)}`;
        }

        function renderKeys() {
            const keys = loadKeys();
            const listDiv = document.getElementById('keysList');

            if (keys.length === 0) {
                listDiv.innerHTML = `
                    <div class="empty-state">
                        <p>ğŸ“­ è¿˜æ²¡æœ‰ä¿å­˜ä»»ä½• API Key</p>
                        <p>åœ¨ä¸Šæ–¹æ·»åŠ ä½ çš„ç¬¬ä¸€ä¸ª Key</p>
                    </div>
                `;
                return;
            }

            listDiv.innerHTML = keys.map(key => `
                <div class="key-item">
                    <div class="key-info">
                        <h3>${key.name}</h3>
                        <p><strong>æœåŠ¡å•†ï¼š</strong>${getProviderName(key.provider)}</p>
                        <p><strong>Keyï¼š</strong><span class="key-value">${maskKey(key.key)}</span></p>
                        <p><strong>åˆ›å»ºæ—¶é—´ï¼š</strong>${new Date(key.createdAt).toLocaleString('zh-CN')}</p>
                        ${key.lastUsed ? `<p><strong>æœ€åä½¿ç”¨ï¼š</strong>${new Date(key.lastUsed).toLocaleString('zh-CN')}</p>` : ''}
                    </div>
                    <div class="key-actions">
                        <button class="secondary" onclick="useKey('${key.id}')">âœ… ä½¿ç”¨</button>
                        <button class="primary" onclick="copyKey('${key.id}')">ğŸ“‹ å¤åˆ¶</button>
                        <button class="danger" onclick="deleteKey('${key.id}')">ğŸ—‘ï¸ åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }

        function getProviderName(provider) {
            const names = {
                'openai': 'OpenAI',
                'replicate': 'Replicate',
                'azure': 'Azure OpenAI',
                'anthropic': 'Anthropic Claude',
                'doubao': 'è±†åŒ…',
                'custom': 'è‡ªå®šä¹‰'
            };
            return names[provider] || provider;
        }

        function addKey() {
            const provider = document.getElementById('newProvider').value;
            const name = document.getElementById('newName').value.trim();
            const key = document.getElementById('newKey').value.trim();

            if (!name) {
                alert('è¯·è¾“å…¥åç§°');
                return;
            }

            if (!key) {
                alert('è¯·è¾“å…¥ API Key');
                return;
            }

            const keys = loadKeys();
            const newKey = {
                id: `key_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                provider,
                name,
                key,
                createdAt: new Date().toISOString(),
            };

            keys.push(newKey);
            saveKeys(keys);

            // æ¸…ç©ºè¡¨å•
            document.getElementById('newName').value = '';
            document.getElementById('newKey').value = '';

            alert('âœ… API Key å·²ä¿å­˜ï¼');
            renderKeys();
        }

        function deleteKey(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ª API Key å—ï¼Ÿ')) {
                return;
            }

            const keys = loadKeys();
            const filtered = keys.filter(k => k.id !== id);
            saveKeys(filtered);

            alert('âœ… API Key å·²åˆ é™¤');
            renderKeys();
        }

        function copyKey(id) {
            const keys = loadKeys();
            const key = keys.find(k => k.id === id);

            if (key) {
                navigator.clipboard.writeText(key.key).then(() => {
                    alert('âœ… API Key å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                }).catch(err => {
                    alert('å¤åˆ¶å¤±è´¥ï¼š' + err.message);
                });
            }
        }

        function useKey(id) {
            const keys = loadKeys();
            const key = keys.find(k => k.id === id);

            if (!key) {
                alert('Key ä¸å­˜åœ¨');
                return;
            }

            // æ›´æ–°æœ€åä½¿ç”¨æ—¶é—´
            key.lastUsed = new Date().toISOString();
            saveKeys(keys);

            // è·å–å½“å‰è®¾ç½®
            const settingsStr = localStorage.getItem('english-trainer-ai-settings');
            const settings = settingsStr ? JSON.parse(settingsStr) : {};

            // æ›´æ–°è®¾ç½®
            settings.provider = key.provider;
            settings.apiKey = key.key;
            settings.savedKeyId = key.id;

            // æ ¹æ®æœåŠ¡å•†è®¾ç½® endpoint
            const endpoints = {
                'openai': 'https://api.openai.com/v1/chat/completions',
                'replicate': 'https://api.replicate.com',
                'azure': '',
                'anthropic': 'https://api.anthropic.com/v1/messages',
                'doubao': 'https://ark.cn-beijing.volces.com/api/v3/chat/completions',
            };
            settings.endpoint = endpoints[key.provider] || '';

            // è®¾ç½®é»˜è®¤æ¨¡å‹
            const models = {
                'openai': 'gpt-3.5-turbo',
                'replicate': 'meta/gemma-2-27b-it',
                'anthropic': 'claude-3-sonnet',
                'doubao': 'doubao-pro-32k',
            };
            if (!settings.model || settings.provider !== key.provider) {
                settings.model = models[key.provider] || '';
            }

            // ä¿å­˜è®¾ç½®
            localStorage.setItem('english-trainer-ai-settings', JSON.stringify(settings));

            alert(`âœ… å·²åˆ‡æ¢åˆ°ï¼š${key.name}\n\nè¯·åˆ·æ–°åº”ç”¨é¡µé¢ä»¥åº”ç”¨æ–°è®¾ç½®ã€‚`);
            renderKeys();
        }

        // é¡µé¢åŠ è½½æ—¶æ¸²æŸ“
        window.onload = renderKeys;
    </script>
</body>
</html>
